<html>
<head>
<meta http-equiv="Content-Type: text/html; charset=UTF-8">
<style type="text/css">
* {
    cursor: default;
    font-family: 'lucida grande';
}

html {
    background: -webkit-gradient(
        linear, left top, left bottom, 
        from(#464646),
        to(#292929)
    );
    color: #fff;
    font-size: 12px;
}

.button {
    padding: 4px;
    background: #888888;
    border-radius: 3px;
    font-weight: bold;
}

#track {
    font-weight: bold;
}

.stopped #stop {
    display: none;
}

.playing #resume {
    display: none;
}

#stop, #resume {
    display: inline-block;
    font-size: 30px;
    line-height: .5em;
    height: 20px;
    width: 20px;
    text-align: center;
}

#position {
    height: 4px;
    width: 50%;
    background-color: #fff;
}

#scrubber {
    background-color: #666;
}
</style>
<script src="mootools-core-1.3-full-nocompat-yc.js"></script>
<script src="core.js"></script>
<script type="text/javascript">
function setStatus(status) {
    //$('status').set('html', status);
}
var ws = new WebSocket('ws://localhost:9999/monitor');
ws.onopen = function () {
  console.log('open');
};

ws.onerror = function () {
  setStatus('spotfm error');
};

ws.onclose = function () {
   setStatus('spotfm error');
};

ws.onmessage = function (a) {
    if (a.data.length > 0) {
        var j = JSON.parse(a.data);
        if (j.event == 'track_info') {
            $('track').set('html', j.track_name);
            $('album').set('html', j.album_name);
            $('artist').set('html', j.artist_name);
            duration = j.track_duration;
        }
        else if (j.event == 'playing') {
            setPosition(lastPosition);
            positionUpdateInterval = window.setInterval(updatePosition, 500);
            $(document.body).addClass('playing');
            $(document.body).removeClass('stopped');
        }
        else if (j.event == 'stopped') {
            window.clearInterval(positionUpdateInterval);
            $(document.body).addClass('stopped');
            $(document.body).removeClass('playing');
        }
        else if (j.event == 'position') {
            setPosition(j.position);
        }
    }
};

function setPosition(position) {
    lastPosition = position;
    timeOffset = new Date().getTime() - position;
    drawPosition(position);
}

function drawPosition(position) {
    var percent = 0;

    if (duration > 0) {
        percent = (position / duration * 100).toFixed(2);
    }

    $('position').setStyle('width', percent + '%');
}

var timeOffset;
var duration;
var lastPosition = 0;
var positionUpdateInterval;

function resume() {
    spotfm.resume();
}

function stop() {
    spotfm.stop();
}

function updatePosition() {
    var now = new Date().getTime();
    var played = now - timeOffset;
    if (played >= duration) {
        window.clearInterval(positionUpdateInterval);
        drawPosition(duration);
        return;
    }
    drawPosition(played);
}
</script>
</head>
<body>
<!--<p><strong>Status:</strong> <span id="status"></span></p>-->
<div id="track"></div>
<div id="album"></div>
<div id="artist"></div>

<p><span class="button" id="stop">■</span>
<span class="button" id="resume">‣</span></p>
<div id="scrubber"><div id="position"></div></div>
<script type="text/javascript">
$('stop').addEvent('click', stop);
$('resume').addEvent('click', resume);
</script>
</body>
</html>